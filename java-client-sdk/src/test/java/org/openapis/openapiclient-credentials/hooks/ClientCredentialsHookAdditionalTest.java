/* 
 * Code generated by Speakeasy (https://speakeasy.com). DO NOT EDIT.
 */

package org.openapis.clientcredentials.openapi.hooks;

import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.time.OffsetDateTime;
import java.time.temporal.ChronoUnit;
import java.util.List;
import java.util.Optional;

import org.junit.jupiter.api.Test;
import org.openapis.clientcredentials.openapi.utils.SessionManager;
import org.openapis.clientcredentials.openapi.utils.SessionManager.HasSessionKey;
import org.openapis.clientcredentials.openapi.utils.SessionManager.Session;

public class ClientCredentialsHookAdditionalTest {

    @Test
    public void testIsExpiredWhenNoTokenExpiryKnown() {
        assertTrue(SessionManager.hasTokenExpired(Optional.empty(), OffsetDateTime.now()));
    }

    @Test
    public void testNotExpiredWhenTokenExpiryMoreThanThresholdSecondsInFuture() {
        OffsetDateTime now = OffsetDateTime.now();
        OffsetDateTime expiry = now.plus(SessionManager.REFRESH_BEFORE_EXPIRY_SECONDS + 1, ChronoUnit.SECONDS);
        assertFalse(SessionManager.hasTokenExpired(Optional.of(expiry), now));
    }

    @Test
    public void testIsExpiredWhenTokenExpiryLessThanThresholdSecondsInFuture() {
        OffsetDateTime now = OffsetDateTime.now();
        OffsetDateTime expiry = now.plus(SessionManager.REFRESH_BEFORE_EXPIRY_SECONDS / 2, ChronoUnit.SECONDS);
        assertTrue(SessionManager.hasTokenExpired(Optional.of(expiry), now));
    }

    @Test
    public void testShouldCreateNewSessionIfNoSessionPresent() {
        assertTrue(SessionManager.shouldCreateNewSession(Optional.empty(), Optional.of(List.of("read"))));
    }

    @Test
    public void testShouldCreateNewSessionIfSessionPresentAndScopesNotMatched() {
        Session<MyCredentials> session = new Session<>(new MyCredentials(), //
                Optional.of("token"), //
                List.of("read", "write"), //s
                Optional.of(OffsetDateTime.now().plus(1, ChronoUnit.DAYS)));
        assertTrue(SessionManager.shouldCreateNewSession(Optional.of(session), Optional.of(List.of("read", "explode"))));
        assertFalse(SessionManager.shouldCreateNewSession(Optional.of(session), Optional.of(List.of("read"))));
    }
    
    @Test
    public void testShouldCreateNewSessionIfSessionPresentAndAllScopesFoundInSession() {
        Session<MyCredentials> session = new Session<>(new MyCredentials(), //
                Optional.of("token"), //
                List.of("read", "write"), //
                Optional.of(OffsetDateTime.now().plus(1, ChronoUnit.DAYS)));
        assertFalse(SessionManager.shouldCreateNewSession(Optional.of(session), Optional.of(List.of("read"))));
    }
    
    @Test
    public void testShouldCreateNewSessionIfSessionPresentButExpired() {
        Session<MyCredentials> session = new Session<>(new MyCredentials(), //
                Optional.of("token"), //
                List.of("read", "write"), //
                Optional.of(OffsetDateTime.now().plus(-1, ChronoUnit.DAYS)));
        assertTrue(SessionManager.shouldCreateNewSession(Optional.of(session), Optional.of(List.of("read"))));
    }
    
    public static final class MyCredentials implements HasSessionKey {

        @Override
        public String sessionKey() {
            return "key";
        }
        
    }
}
