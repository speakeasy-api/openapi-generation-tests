/* 
 * Code generated by Speakeasy (https://speakeasy.com). DO NOT EDIT.
 */

package org.openapis.openapi;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.openapis.openapi.CommonHelpers.recordTest;

import java.io.IOException;
import java.io.InputStream;
import java.net.URISyntaxException;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.stream.Stream;

import org.junit.jupiter.api.Test;
import org.openapis.openapi.models.operations.PaginationCursorBodyRequestBody;
import org.openapis.openapi.models.operations.PaginationCursorBodyResponse;
import org.openapis.openapi.models.operations.PaginationCursorNonNumericResponse;
import org.openapis.openapi.models.operations.PaginationCursorParamsResponse;
import org.openapis.openapi.models.operations.PaginationLimitOffsetOffsetBodyResponse;
import org.openapis.openapi.models.operations.PaginationLimitOffsetOffsetParamsResponse;
import org.openapis.openapi.models.operations.PaginationLimitOffsetPageBodyResponse;
import org.openapis.openapi.models.operations.PaginationLimitOffsetDeepOutputsPageBodyResponse;
import org.openapis.openapi.models.operations.PaginationLimitOffsetPageParamsResponse;
import org.openapis.openapi.models.operations.PaginationWithRetriesResponse;
import org.openapis.openapi.models.shared.LimitOffsetConfig;
import org.openapis.openapi.utils.HTTPClient;
import org.openapis.openapi.utils.SpeakeasyHTTPClient;

public class PaginationTests {

    @Test
    void paginationLimitOffsetPageParams() throws Exception {
        recordTest("pagination-limit-offset-page-params");

        SDK s = SDK.builder().build();

        long serverLimit = 20l;

        PaginationLimitOffsetPageParamsResponse res =
                s.pagination().paginationLimitOffsetPageParams().page(1).call();

        assertNotNull(res);
        assertEquals(200, res.statusCode());
        assertEquals(serverLimit, res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetPageParamsResponse> nextRes = res.next();
        assertTrue(nextRes.isPresent());
        res = nextRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(0, res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetPageParamsResponse> nullRes = res.next();
        assertFalse(nullRes.isPresent());
    }
    
    @Test
    void paginationLimitOffsetPageParamsUnwrapped() throws Exception {
        SDK s = SDK.builder().build();

        long serverLimit = 20l;

        Stream<Long> results = s.pagination().paginationLimitOffsetPageParams().page(1).callAsStreamUnwrapped();
        assertEquals(serverLimit, results.count());
    }

    @Test
    void paginationLimitOffsetPageBody() throws Exception {
        recordTest("pagination-limit-offset-page-body");

        SDK s = SDK.builder().build();

        Long page = 1l;
        Long limit = 15l;


        LimitOffsetConfig request =
                LimitOffsetConfig.builder().limit(limit).page(page).build();
        PaginationLimitOffsetPageBodyResponse res =
                s.pagination().paginationLimitOffsetPageBody(request, Optional.empty());

        assertNotNull(res);
        assertEquals(200, res.statusCode());
        assertEquals(limit, res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetPageBodyResponse> nextRes = res.next();
        assertTrue(nextRes.isPresent());
        res = nextRes.get();
        assertEquals(200, res.statusCode());
        assertTrue(limit > res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetPageBodyResponse> nullRes = res.next();
        assertFalse(nullRes.isPresent());

    }

    @Test
    void paginationLimitOffsetDeepOutputsPageBody() throws Exception {
        recordTest("pagination-limit-offset-deep-outputs-page-body");

        SDK s = SDK.builder().build();

        Long page = 1l;
        Long limit = 15l;


        LimitOffsetConfig request =
                LimitOffsetConfig.builder().limit(limit).page(page).build();
        PaginationLimitOffsetDeepOutputsPageBodyResponse res =
                s.pagination().paginationLimitOffsetDeepOutputsPageBody(request, Optional.empty());

        assertNotNull(res);
        assertEquals(200, res.statusCode());
        assertEquals(limit, res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetDeepOutputsPageBodyResponse> nextRes = res.next();
        assertTrue(nextRes.isPresent());
        res = nextRes.get();
        assertEquals(200, res.statusCode());
        assertTrue(limit > res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetDeepOutputsPageBodyResponse> nullRes = res.next();
        assertFalse(nullRes.isPresent());

    }
    
    @Test
    void paginationLimitOffsetPageBodyUnwrapped() throws Exception {
        SDK s = SDK.builder().build();

        long page = 1;
        long limit = 15;

        LimitOffsetConfig request =
                LimitOffsetConfig.builder().limit(limit).page(page).build();
        Stream<Long> results = s.pagination().paginationLimitOffsetPageBody()
                .request(request)
                .callAsStreamUnwrapped();
        assertEquals(20, results.count());
    }

    @Test
    void paginationLimitOffsetOffsetParams() throws Exception {
        recordTest("pagination-limit-offset-offset-params");

        SDK s = SDK.builder().build();
        assertNotNull(s);

        Long limit = 15l;
        Long offset = 0l;


        PaginationLimitOffsetOffsetParamsResponse res =
                s.pagination().paginationLimitOffsetOffsetParams(Optional.of(limit),
                        Optional.of(offset), Optional.empty());

        assertNotNull(res);
        assertEquals(200, res.statusCode());
        assertEquals(limit, res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetOffsetParamsResponse> nextRes = res.next();
        assertTrue(nextRes.isPresent());
        res = nextRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(20l - limit, res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetOffsetParamsResponse> nullRes = res.next();
        assertFalse(nullRes.isPresent());
    }
    
    @Test
    void paginationLimitOffsetOffsetUnwrapped() throws Exception {
        SDK s = SDK.builder().build();

        long limit = 15;
        long offset = 0;

        Stream<Long> results = s.pagination().paginationLimitOffsetOffsetParams()
                .limit(limit) //
                .offset(offset)//
                .callAsStreamUnwrapped();
        assertEquals(20, results.count());
    }

    @Test
    void paginationLimitOffsetOffsetBody() throws Exception {
        recordTest("pagination-limit-offset-offset-body");

        SDK s = SDK.builder().build();

        long limit = 15;
        long offset = 0;

        LimitOffsetConfig request =
                LimitOffsetConfig.builder() //
                  .limit(limit) //
                  .offset(offset) //
                  .build();
        
        PaginationLimitOffsetOffsetBodyResponse res =
                s.pagination().paginationLimitOffsetOffsetBody(request, Optional.empty());

        assertNotNull(res);
        assertEquals(200, res.statusCode());
        assertEquals(limit, res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetOffsetBodyResponse> nextRes = res.next();
        assertTrue(nextRes.isPresent());
        res = nextRes.get();
        assertEquals(200, res.statusCode());
        assertTrue(limit > res.res().get().resultArray().size());

        Optional<PaginationLimitOffsetOffsetBodyResponse> nullRes = res.next();
        assertFalse(nullRes.isPresent());
    }
    
    @Test
    void paginationLimitOffsetOffsetBodyUnwrapped() throws Exception {
        SDK s = SDK.builder().build();

        long limit = 15;
        long offset = 0;

        LimitOffsetConfig request =
                LimitOffsetConfig.builder() //
                    .limit(limit) //
                    .offset(offset) //
                    .build();
        Stream<Long> results = s.pagination().paginationLimitOffsetOffsetBody()
                    .request(request)
                    .callAsStreamUnwrapped();
        assertEquals(20, results.count());
    }

    @Test
    void paginationCursorParams() throws Exception {
        recordTest("pagination-cursor-params");

        SDK s = SDK.builder().build();

        long cursor = -1;

        PaginationCursorParamsResponse res =
                s.pagination().paginationCursorParams(cursor, Optional.empty());

        assertNotNull(res);
        assertEquals(200, res.statusCode());
        assertEquals(15, res.res().get().resultArray().size());

        Optional<PaginationCursorParamsResponse> nextRes = res.next();
        assertTrue(nextRes.isPresent());
        res = nextRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(5, res.res().get().resultArray().size());

        Optional<PaginationCursorParamsResponse> penultimateRes = res.next();
        assertTrue(penultimateRes.isPresent());
        res = penultimateRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(0, res.res().get().resultArray().size());

        Optional<PaginationCursorParamsResponse> nullRes = res.next();
        assertFalse(nullRes.isPresent());
    }
    
    @Test
    void paginationCursorParamsUnwrapped() throws Exception {
        SDK s = SDK.builder().build();

        long cursor = -1;

        Stream<Long> results =
                s.pagination().paginationCursorParams()
                .cursor(cursor)
                .callAsStreamUnwrapped();
        assertEquals(20, results.count());
    }

    @Test
    void paginationCursorBody() throws Exception {
        recordTest("pagination-cursor-body");

        SDK s = SDK.builder().build();
        assertNotNull(s);

        Long cursor = -1l;

        PaginationCursorBodyRequestBody request = new PaginationCursorBodyRequestBody(cursor);

        PaginationCursorBodyResponse res =
                s.pagination().paginationCursorBody(request, Optional.empty());

        assertNotNull(res);
        assertEquals(200, res.statusCode());
        assertEquals(15, res.res().get().resultArray().size());

        Optional<PaginationCursorBodyResponse> nextRes = res.next();
        assertTrue(nextRes.isPresent());
        res = nextRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(5, res.res().get().resultArray().size());

        Optional<PaginationCursorBodyResponse> penultimateRes = res.next();
        assertTrue(penultimateRes.isPresent());
        res = penultimateRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(0, res.res().get().resultArray().size());

        Optional<PaginationCursorBodyResponse> nullRes = res.next();
        assertFalse(nullRes.isPresent());
    }
    
    @Test
    void paginationCursorBodyUnwrapped() throws Exception {
        SDK s = SDK.builder().build();

        long cursor = -1;

        PaginationCursorBodyRequestBody request = new PaginationCursorBodyRequestBody(cursor);

        Stream<Long> results =
                s.pagination().paginationCursorBody()
                .request(request)
                .callAsStreamUnwrapped();
        assertEquals(20, results.count());
    }

    @Test
    void paginationCursorNonNumeric() throws Exception {
        recordTest("pagination-cursor-non-numeric");
        SDK s = SDK.builder().build();

        PaginationCursorNonNumericResponse res = s.pagination().paginationCursorNonNumeric().call();

        assertNotNull(res);
        assertEquals(200, res.statusCode());
        assertEquals(15, res.res().get().resultArray().size());

        Optional<PaginationCursorNonNumericResponse> nextRes = res.next();
        assertTrue(nextRes.isPresent());
        res = nextRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(5, res.res().get().resultArray().size());

        Optional<PaginationCursorNonNumericResponse> penultimateRes = res.next();
        assertTrue(penultimateRes.isPresent());
        res = penultimateRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(0, res.res().get().resultArray().size());

        assertFalse(res.next().isPresent());
    }
    
    @Test
    void paginationCursorNonNumericUnwrapped() throws Exception {
        SDK s = SDK.builder().build();

        Stream<String> results = s.pagination().paginationCursorNonNumeric().callAsStreamUnwrapped();
        assertEquals(20, results.count());
    }


    @Test
    void paginationCursorBodyAsStream() throws Exception {
        recordTest("pagination-cursor-body");

        SDK s = SDK.builder().build();

        long cursor = -1l;

        PaginationCursorBodyRequestBody request = new PaginationCursorBodyRequestBody(cursor);

        long pagesCount = s.pagination().paginationCursorBody().request(request).callAsStream()
                .flatMap(x -> x.res().stream()).count();
        assertEquals(3, pagesCount);

        long itemsCount = s.pagination().paginationCursorBody().request(request)
                .callAsStreamUnwrapped()
                .count();
        assertEquals(20, itemsCount);
    }
    
    @Test
    void paginationWithRetries() throws Exception {
        recordTest("pagination-with-retries");
        SpeakeasyHTTPClient client = new SpeakeasyHTTPClient();
        PaginationRecordingClient recordingClient = new PaginationRecordingClient(client);

        SDK s = SDK.builder().client(recordingClient).build();

        PaginationWithRetriesResponse res = s.pagination().paginationWithRetries() 
                .requestId(UUID.randomUUID().toString())
                .call();

        int count = 0;

        assertNotNull(res);
        assertEquals(200, res.statusCode());
        assertEquals(15, res.res().get().resultArray().size());
        count += res.res().get().resultArray().size();

        Optional<PaginationWithRetriesResponse> nextRes = res.next();
        assertTrue(nextRes.isPresent());
        res = nextRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(5, res.res().get().resultArray().size());
        count += res.res().get().resultArray().size();

        Optional<PaginationWithRetriesResponse> penultimateRes = res.next();
        assertTrue(penultimateRes.isPresent());
        res = penultimateRes.get();
        assertEquals(200, res.statusCode());
        assertEquals(0, res.res().get().resultArray().size());

        assertFalse(res.next().isPresent());

        assertEquals(20, count);

        var expected = List.of(
          "503:GET:/pagination/cursor_non_numeric",
          "503:GET:/pagination/cursor_non_numeric",
          "503:GET:/pagination/cursor_non_numeric",
          "200:GET:/pagination/cursor_non_numeric",
          "200:GET:/pagination/cursor_non_numeric",
          "200:GET:/pagination/cursor_non_numeric"
        );

        assertEquals(expected, recordingClient.log());
    }
    
    @Test
    void paginationWithRetriesUnwrapped() throws Exception {
        SpeakeasyHTTPClient client = new SpeakeasyHTTPClient();
        PaginationRecordingClient recordingClient = new PaginationRecordingClient(client);

        SDK s = SDK.builder().client(recordingClient).build();

        Stream<String> results = s.pagination().paginationWithRetries() 
                .requestId(UUID.randomUUID().toString())
                .callAsStreamUnwrapped();

        assertEquals(20, results.count());

        var expected = List.of(
          "503:GET:/pagination/cursor_non_numeric",
          "503:GET:/pagination/cursor_non_numeric",
          "503:GET:/pagination/cursor_non_numeric",
          "200:GET:/pagination/cursor_non_numeric",
          "200:GET:/pagination/cursor_non_numeric",
          "200:GET:/pagination/cursor_non_numeric"
        );

        assertEquals(expected, recordingClient.log());
    }

    private static final class PaginationRecordingClient implements HTTPClient {
        private final HTTPClient client;
        private final List<String> log = new ArrayList<>();

        PaginationRecordingClient(HTTPClient client) {
            this.client = client;
        }

        @Override
        public HttpResponse<InputStream> send(HttpRequest request)
                throws IOException, InterruptedException, URISyntaxException {
            HttpResponse<InputStream> response = client.send(request);
            this.log.add(response.statusCode() + ":" + request.method() + ":" + request.uri().getPath());
            return response;
        }

        List<String> log() {
            return log;
        }
    }
    
}
